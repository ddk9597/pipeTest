name: AI Staff (Claude->Codex->Claude loop)

on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  ai_staff:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
      MAX_ITERS: "5"

    steps:
      - uses: actions/checkout@v4

      - name: Prepare inputs (PR title/body)
        run: |
          DELIM="__PR_INPUT_EOF__"
          cat <<$DELIM > input.md
          # PR Title
          ${{ github.event.pull_request.title }}

          # PR Body
          ${{ github.event.pull_request.body }}
          $DELIM

      - name: Install python deps
        run: |
          python -m pip install --upgrade pip
          pip install requests

      - name: Run loop (Claude plan -> Codex patch -> Claude verify)
        run: |
          python .github/scripts/ai_staff_loop.py

      - name: Upload report artifacts
        uses: actions/upload-artifact@v4
        with:
          name: ai-staff-report
          path: |
            report.md
            plan.md
            patch.diff
            verify.json
